<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>File System Access POC – Image Save</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --panel: #0b1120;
      --accent: #16a34a;
      --accent-soft: #1f2937;
      --danger: #b91c1c;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .wrap {
      width: 100%;
      max-width: 480px;
      padding: 1.25rem;
    }
    .card {
      background: var(--panel);
      border-radius: 1rem;
      padding: 1.25rem 1.5rem 1.5rem;
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
      border: 1px solid rgba(148,163,184,0.18);
    }
    h1 {
      font-size: 1.15rem;
      margin: 0 0 0.25rem;
    }
    p {
      margin: 0.25rem 0;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.25rem;
    }
    button {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 0.7rem 0.8rem;
      background: var(--accent-soft);
      color: var(--text);
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s;
    }
    button.primary {
      background: var(--accent);
    }
    button.danger {
      background: var(--danger);
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
      opacity: 0.9;
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .status {
      margin-top: 1rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      background: #020617;
      border-radius: 0.75rem;
      padding: 0.6rem 0.75rem;
      max-height: 8rem;
      overflow-y: auto;
      white-space: pre-wrap;
      border: 1px solid rgba(31,41,55,0.9);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.7rem;
      margin-top: 0.4rem;
      background: rgba(15,118,110,0.18);
      border: 1px solid rgba(34,197,94,0.45);
      color: #a7f3d0;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Image save test (File System Access)</h1>
      <p>
        1. Tap <strong>Choose folder</strong> and pick a directory.<br />
        2. Then hit <strong>Save test image</strong> a few times.
      </p>
      <p class="badge" id="support-badge">Checking support…</p>

      <div class="buttons">
        <button id="btn-choose" class="primary">Choose folder</button>
        <button id="btn-save" disabled>Save test image</button>
      </div>

      <div class="status" id="status"></div>
    </div>
  </div>

  <script>
    const DB_NAME = "fs-access-demo";
    const STORE_NAME = "handles";
    const KEY_DIR = "directory";

    const logEl = document.getElementById("status");
    const btnChoose = document.getElementById("btn-choose");
    const btnSave = document.getElementById("btn-save");
    const badge = document.getElementById("support-badge");

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }

    function openDb() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function saveDirectoryHandle(handle) {
      const db = await openDb();
      const tx = db.transaction(STORE_NAME, "readwrite");
      tx.objectStore(STORE_NAME).put(handle, KEY_DIR);
      return new Promise((resolve, reject) => {
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }

    async function loadDirectoryHandle() {
      const db = await openDb();
      const tx = db.transaction(STORE_NAME, "readonly");
      const req = tx.objectStore(STORE_NAME).get(KEY_DIR);
      return new Promise((resolve, reject) => {
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }

    async function ensurePermission(handle) {
      if (!handle) return false;
      const current = await handle.queryPermission({ mode: "readwrite" });
      if (current === "granted") return true;
      if (current === "denied") return false;
      const requested = await handle.requestPermission({ mode: "readwrite" });
      return requested === "granted";
    }

    async function createTestImageBlob() {
      return new Promise((resolve, reject) => {
        const c = document.createElement("canvas");
        c.width = 1024;
        c.height = 576;
        const ctx = c.getContext("2d");

        const grd = ctx.createLinearGradient(0, 0, c.width, c.height);
        grd.addColorStop(0, "#0f172a");
        grd.addColorStop(1, "#16a34a");
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, c.width, c.height);

        ctx.fillStyle = "rgba(15,23,42,0.7)";
        ctx.fillRect(48, 48, c.width - 96, c.height - 96);

        ctx.fillStyle = "#e5e7eb";
        ctx.font = "36px system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("Site Evidence Test Image", c.width / 2, c.height / 2 - 10);

        ctx.font = "22px system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
        ctx.fillStyle = "#a5b4fc";
        ctx.fillText(new Date().toLocaleString(), c.width / 2, c.height / 2 + 30);

        c.toBlob((blob) => {
          if (!blob) reject(new Error("Failed to create blob"));
          else resolve(blob);
        }, "image/png");
      });
    }

    async function saveImageToFolder(filename) {
      let dirHandle = await loadDirectoryHandle();
      if (!dirHandle) {
        log("No directory handle stored yet.");
        btnSave.disabled = true;
        return;
      }

      const ok = await ensurePermission(dirHandle);
      if (!ok) {
        log("Permission not granted. Choose folder again.");
        btnSave.disabled = true;
        return;
      }

      const blob = await createTestImageBlob();
      const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      log(`Saved ${filename} into selected folder.`);
    }

    async function init() {
      if (!("showDirectoryPicker" in window)) {
        badge.textContent = "File System Access API not supported.";
        badge.style.background = "rgba(127,29,29,0.35)";
        badge.style.borderColor = "rgba(248,113,113,0.7)";
        log("This browser does not support showDirectoryPicker(). Use Chrome/Edge on desktop or Android.");
        btnChoose.disabled = true;
        btnSave.disabled = true;
        return;
      }

      badge.textContent = "File System Access supported.";
      log("File System Access API detected.");

      const existing = await loadDirectoryHandle();
      if (existing && (await ensurePermission(existing))) {
        log("Existing directory handle loaded and permission granted.");
        btnSave.disabled = false;
      } else if (existing) {
        log("Existing handle found but no permission. User must reselect folder.");
      } else {
        log("No stored directory handle yet. Choose a folder to begin.");
      }

      btnChoose.addEventListener("click", async () => {
        try {
          const dirHandle = await window.showDirectoryPicker();
          const allowed = await ensurePermission(dirHandle);
          if (!allowed) {
            log("User denied read/write access.");
            btnSave.disabled = true;
            return;
          }
          await saveDirectoryHandle(dirHandle);
          log("Directory handle stored. You can now save images without further prompts (while permission lasts).");
          btnSave.disabled = false;
        } catch (err) {
          log("Folder selection cancelled or failed: " + err.message);
        }
      });

      btnSave.addEventListener("click", async () => {
        btnSave.disabled = true;
        try {
          const ts = new Date()
            .toISOString()
            .replace(/[:.]/g, "-")
            .replace("T", "_")
            .slice(0, 19);
          const name = `evidence-${ts}.png`;
          await saveImageToFolder(name);
        } catch (err) {
          log("Save failed: " + err.message);
        } finally {
          btnSave.disabled = false;
        }
      });
    }

    init().catch((err) => {
      log("Fatal error during init: " + err.message);
    });
  </script>
</body>
</html>
