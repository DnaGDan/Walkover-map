<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo Logger • Minimal, Restarted, Closed Properly</title>
  <style>
    :root { --bg:#0f172a; --fg:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; --warn:#f59e0b; --err:#f87171; }
    html,body{height:100%}
    body{margin:0;padding:20px;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    h1{margin:0 0 12px 0;font-size:20px}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    button{background:#1e3a8a;border:1px solid #60a5fa;color:#fff;font-weight:600;border-radius:8px;padding:10px 14px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    #log{background:#111827;color:#fbbf24;padding:10px;border-radius:8px;white-space:pre-wrap;min-height:72px;max-height:180px;overflow:auto}
    video,img{display:block;margin-top:12px;max-width:100%;border-radius:10px}
    .pill{display:inline-block;border:1px solid #263040;border-radius:999px;padding:6px 10px;color:#9ca3af}
  </style>
</head>
<body>
  <h1>Photo Logger (Restarted Minimal Build)</h1>
  <div class="row">
    <button id="btnStart">Start Camera + GPS</button>
    <button id="btnCapture" disabled>Capture Photo</button>
    <button id="btnRunTests">Run self‑tests</button>
    <span id="status" class="pill">Idle</span>
  </div>
  <div id="log">Ready…</div>
  <video id="preview" autoplay playsinline></video>
  <img id="photo" alt="Captured photo" />

  <script>
    // ===== DOM =====
    const els = {
      btnStart: document.getElementById('btnStart'),
      btnCapture: document.getElementById('btnCapture'),
      btnRunTests: document.getElementById('btnRunTests'),
      log: document.getElementById('log'),
      status: document.getElementById('status'),
      video: document.getElementById('preview'),
      photo: document.getElementById('photo')
    };

    // ===== State =====
    let stream = null;
    let currentPosition = null; // { latitude, longitude, accuracy }

    function log(msg){ els.log.textContent += '\n' + msg; els.log.scrollTop = els.log.scrollHeight; }
    function setStatus(text, color){ els.status.textContent = text; els.status.style.color = color || '#9ca3af'; }

    // ===== Camera + GPS start =====
    async function startCameraAndGPS(){
      // HTTPS sanity: many APIs require secure context
      if (!isSecureContext){
        alert('This page must be served over HTTPS for camera/GPS to work. Use your GitHub Pages URL, not a repo preview.');
        log('Blocked: not a secure context.');
        return;
      }

      // Start camera
      try{
        log('Requesting camera…');
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
        els.video.srcObject = stream;
        els.btnCapture.disabled = false;
        log('Camera started.');
      }catch(e){
        log('Camera error: ' + (e && e.message || e));
      }

      // Start GPS (permission via one-shot first)
      if (!('geolocation' in navigator)){
        log('Geolocation not supported in this browser.');
        return;
      }
      setStatus('Requesting GPS…', '#f59e0b');
      log('Requesting GPS position…');
      navigator.geolocation.getCurrentPosition(onFix, onFixError, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });

      function onFix(pos){
        const { latitude, longitude, accuracy } = pos.coords;
        currentPosition = { latitude, longitude, accuracy };
        log(`GPS fix: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (±${accuracy.toFixed(1)}m)`);
        setStatus('Tracking', '#60a5fa');
      }
      function onFixError(err){
        log(`GPS error (${err.code}): ${err.message}`);
        if (err.code === 1){
          alert('Location permission denied. Tap the padlock → Site settings → Location → Allow, then reload.');
        } else if (err.code === 2){
          alert('Location unavailable. Turn on GPS and set Location mode to High accuracy.');
        } else if (err.code === 3){
          alert('Timed out waiting for GPS. Go outside or near a window and try again.');
        }
        setStatus('Idle');
      }
    }

    // ===== Capture photo =====
    function capturePhoto(){
      if (!stream){ log('Camera stream not active.'); return; }
      const track = stream.getVideoTracks()[0];
      // If ImageCapture is missing, fallback to canvas grab
      if (typeof ImageCapture === 'function'){
        const cap = new ImageCapture(track);
        cap.takePhoto().then(blob => showBlob(blob)).catch(e => {
          log('takePhoto failed, falling back to canvas: ' + (e && e.message || e));
          fallbackGrab();
        });
      } else {
        fallbackGrab();
      }

      function fallbackGrab(){
        try{
          const canvas = document.createElement('canvas');
          const settings = track.getSettings ? track.getSettings() : {};
          const w = settings.width || 1280; const h = settings.height || 720;
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(els.video, 0, 0, w, h);
          canvas.toBlob(showBlob, 'image/jpeg', 0.92);
        }catch(e){ log('Canvas capture failed: ' + (e && e.message || e)); }
      }

      function showBlob(blob){
        const url = URL.createObjectURL(blob);
        els.photo.src = url;
        log('Photo captured.');
        if (currentPosition){
          log(`Saved with GPS: ${currentPosition.latitude.toFixed(6)}, ${currentPosition.longitude.toFixed(6)}`);
        } else {
          log('No GPS fix yet; capture saved without coordinates.');
        }
      }
    }

    // ===== Self tests (runtime sanity, not browser unit tests) =====
    function runTests(){
      const results = [];
      function assert(name, cond){ results.push({name, pass: !!cond}); if(!cond) console.error('Test failed:', name); }

      // DOM presence
      assert('has Start button', !!els.btnStart);
      assert('has Capture button', !!els.btnCapture);
      assert('has video element', !!els.video);
      assert('has log element', !!els.log);

      // Environment capabilities
      assert('secure context or not required', typeof isSecureContext === 'boolean');
      assert('mediaDevices present', !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia));
      assert('geolocation present', 'geolocation' in navigator);

      // Functions exist
      assert('startCameraAndGPS is function', typeof startCameraAndGPS === 'function');
      assert('capturePhoto is function', typeof capturePhoto === 'function');

      // Capture preconditions
      const prevStream = stream; stream = null; // simulate not started
      try { capturePhoto(); assert('capture without stream logs warning (no throw)', true); } catch(e){ assert('capture without stream does not throw', false); }
      stream = prevStream; // restore

      // HTML closure sanity: we can't read raw source easily, but we can ensure document has an html and body
      assert('documentElement is html', document.documentElement && document.documentElement.nodeName === 'HTML');
      assert('body exists', !!document.body);

      const passed = results.filter(r=>r.pass).length;
      log(`Tests: ${passed}/${results.length} passed`);
      results.forEach(r=> log(`${r.pass ? '✅' : '❌'} ${r.name}`));
    }

    // ===== Wire up =====
    els.btnStart.addEventListener('click', startCameraAndGPS);
    els.btnCapture.addEventListener('click', capturePhoto);
    els.btnRunTests.addEventListener('click', runTests);
  </script>
</body>
</html>
